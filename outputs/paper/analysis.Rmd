---
title: 'The Wage Gap Persists: How pay imbalances by gender unequally reward male
  professors at the University of Toronto'
author: "Thomas Rosenthal"
date: "March 1, 2021"
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
  word_document: default
  github_document:
    html_preview: false
geometry: margin=2.3cm
nocite: '@*'
bibliography: references.bib
thanks: 'Code and data are available at: [github.com/mrpotatocode/UniversitySunshine](https://github.com/mrpotatocode/UniversitySunshine)'
abstract: In this work, Binomial Baseyian analysis releaves the persistance of wage
  gaps by gender among both administrators and professors at the University of Toronto.
  Using Ontario's Public Sectory Salary Disclosure from 2012-2019 (colloquially known
  as 'The Sunshine List', University of Toronto staff populations earning greater
  than $100,000 per annum are compared by gender and title in an effort to exam whether
  or not wages are fairly distributed. Models within find that female professors and
  administators are paid less than their male counterparts with similar titles, and
  this wage gap is increasingly worse year over year.
urlcolor: blue
---

\vspace{-5truemm}

## Introduction

\vspace{-2truemm}

Anintro...

\vspace{-4truemm}

## Data

\vspace{-2truemm}

brief..

\vspace{-4truemm}

### Dataset

\vspace{-2truemm}

Ontario makes available public sector salary disclosure from 1996 to 2019 (or most current year) avialable through the Open Data Ontario portal, or for each year as .csv file from [ontario.ca/page/public-sector-salary-disclosure](https://www.ontario.ca/page/public-sector-salary-disclosure).

Using 


\vspace{-4truemm}

### Gender Assignment Process

\vspace{-2truemm}


### Ethical Considerations 

\vspace{-2truemm}





```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load Libraries
```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(data.table)
library(here)
library(rstanarm)
library(gender)
library(ggplot2)
library(bayesplot)
library(kableExtra)
```

Load Data
```{r message=FALSE, warning=FALSE}
#function for fread (data.table)
read_plus <- function(flnm) {
    read_csv(flnm) %>% 
        mutate(filename = flnm) %>% #adds the filename
        mutate(`Salary Paid` = as.character(`Salary Paid`)) %>% #allows for $000,000 notation, some files were int
        mutate(`Taxable Benefits` = as.character(`Taxable Benefits`)) %>% 
        rename_with(str_to_title) #fixes title case vs lower case issue for colnames between filenames
  }

datafolder = paste0(here(),'/data')

raw_data = 
    list.files(path = datafolder,
      pattern = "*.csv",
      full.names = T) %>% 
    map_df(~read_plus(.))

```

```{r eval=FALSE}
#fix the rows that were skipped
#set the year as 2016, instead of NA
raw_data <- raw_data %>% mutate(`Calendar Year` = if_else(is.na(`Calendar Year`), 2016, `Calendar Year`))
```

```{r eval=FALSE}
raw_data %>% mutate(SalaryPaid = parse_number(`Salary Paid`), .after = "Salary Paid", .keep="unused")  %>%
    map_df(function(x) sum(is.na(x))) %>%
    gather(feature, num_nulls) %>%
    print(n = 100)
```

```{r}
head(raw_data)
```

```{r eval=FALSE}
UofT <- raw_data %>% filter(Employer %in% c('University of Toronto','University Of Toronto')) %>% 
                              rename(FirstName = `First Name`)
```

```{r eval=FALSE}
first_names <- UofT %>% distinct(FirstName)
nrow(first_names)

gendered_names <- gender(first_names$FirstName)
```

```{r eval=FALSE}
UofT_gen <- left_join(UofT, gendered_names, by = c("FirstName" = "name"))
UofT_gen <- UofT_gen %>% mutate(ID = row_number())
nrow(UofT_gen %>% filter(is.na(gender)) %>% distinct(FirstName))
```

```{r message=FALSE, warning=FALSE, eval=FALSE}
adj <- UofT %>%  
  mutate(FirstNameadj = str_replace(FirstName, "\\s", "|")) %>% 
  separate(FirstNameadj, into = c("first","second"), sep = "\\|")

gendered_names <- gender(adj$first)
gendered_names_second <- gender(adj$second)
```

```{r eval=FALSE}
UofT_gen <- left_join(adj, gendered_names, by = c("first" = "name")) %>% distinct()
UofT_gen <- UofT_gen %>% mutate(ID = row_number())

UofT_gen_x <- left_join(adj, gendered_names_second, by = c("second" = "name")) %>% distinct()
UofT_gen <- UofT_gen %>% 
    mutate(gender = coalesce(gender,UofT_gen_x$gender))

nrow(UofT_gen %>% filter(is.na(gender)) %>% distinct(FirstName))
```

```{r message=FALSE, warning=FALSE, eval=FALSE}
adj <-
  UofT %>% 
  mutate(FirstNameadj = str_replace(FirstName, "\\s", "|")) %>% 
  separate(FirstNameadj, into = c("first","second"), sep = "\\|") %>% 
  mutate(paren = str_extract(second, "\\(([^()]*)\\)")) %>% 
  mutate(paren = str_replace(paren,"\\(",'')) %>% 
  mutate(paren = str_replace(paren,"\\)",''))

gendered_names <- gender(adj$paren)
```

```{r eval=FALSE}
UofT_gen_y <- left_join(adj, gendered_names, by = c("paren" = "name")) %>% distinct()
UofT_gen <- UofT_gen %>% 
    mutate(gender = coalesce(gender,UofT_gen_y$gender))

nrow(UofT_gen %>% filter(is.na(gender)) %>% distinct(FirstName))
```

```{r message=FALSE, warning=FALSE, eval=FALSE}
adj <- UofT %>%  
  mutate(FirstNameadj = str_replace(FirstName, "-", "|")) %>% 
  separate(FirstNameadj, into = c("first","second"), sep = "\\|")

gendered_names <- gender(adj$first)
```

```{r eval=FALSE}
UofT_gen_z <- left_join(adj, gendered_names, by = c("first" = "name")) %>% distinct()
UofT_gen <- UofT_gen %>% 
    mutate(gender = coalesce(gender,UofT_gen_z$gender))

nrow(UofT_gen %>% filter(is.na(gender)) %>% distinct(FirstName))
```

```{r eval=FALSE}
UofT_gen <- UofT_gen %>% mutate(SalaryPaid = parse_number(`Salary Paid`), .after = "Salary Paid", .keep="unused")

UofT_gen <- UofT_gen %>% mutate(CalendarYear =  as.factor(`Calendar Year`), .after = "Calendar Year", .keep="unused")
```

```{r message=FALSE, eval=FALSE}
UofT_gen %>% group_by(gender,) %>% 
            summarize(gender_n = n(), 
                      mean_sal = mean(SalaryPaid),
                      max_sal = max(SalaryPaid))

```

```{r eval=FALSE}
`(ᵔᴥᵔ)` <- ggplot(UofT_gen, aes(x=CalendarYear, y=SalaryPaid, fill=gender)) + 
    geom_boxplot(outlier.shape = NA)

ylim1 = boxplot.stats(UofT_gen$SalaryPaid)$stats[c(1, 5)]

`ʕ•ᴥ•ʔ` = `(ᵔᴥᵔ)` + coord_cartesian(ylim = ylim1*1.05)
`ʕ•ᴥ•ʔ` 

```


```{r eval=FALSE}
UofT_prof <- UofT_gen %>% mutate(JobTitleAdj = str_replace(str_replace(`Job Title`, ", ", "|"), " of ","|")) %>% 
            separate(JobTitleAdj, into = c("outer","inner"), sep = "\\|") %>% filter(outer %like% 'rofessor') %>% 
            filter(CalendarYear ==2019) %>% group_by(outer) %>% 
            filter(n() >= 5)


UofT_prof$outer2 <- str_wrap(UofT_prof$outer, width = 15)
`|>.<|` <- ggplot(UofT_prof , aes(x=outer2, y=SalaryPaid, fill=gender)) + 
    geom_boxplot()

ylim1 = boxplot.stats(UofT_prof$SalaryPaid)$stats[c(1, 5)]

`|◉_◉|` = `|>.<|` + coord_cartesian(ylim = ylim1*1.05)
`|◉_◉|` + coord_flip()

```


```{r eval=FALSE}
UofT_dean <- UofT_gen %>% mutate(JobTitleAdj = str_replace(str_replace(`Job Title`, ", ", "|"), " of ","|")) %>% 
            separate(JobTitleAdj, into = c("outer","inner"), sep = "\\|") %>% filter(outer %like% 'Dean') %>% 
            filter(CalendarYear ==2019) %>% group_by(outer) %>% 
            filter(n() >= 5)

UofT_dean$outer2 <- str_wrap(UofT_dean$outer, width = 15)
`|-.-|` <- ggplot(UofT_dean, aes(x=outer2, y=SalaryPaid, fill=gender)) + 
    geom_boxplot()

ylim1 = boxplot.stats(UofT_dean$SalaryPaid)$stats[c(1, 5)]

`|⚆ _ ⚆|` = `|-.-|` + coord_cartesian(ylim = ylim1*1.05)
`|⚆ _ ⚆|` + coord_flip()
```


```{r eval=FALSE}
UofT_ischool <- UofT_gen %>% filter(`Job Title` %like% 'of Information') %>% 
            filter(CalendarYear ==2019) %>% filter(`Last Name` %in% c('Eskenazi','Fiege') == FALSE) %>% 
            mutate(JobTitleAdj = str_replace(str_replace(`Job Title`, ", ", "|"), " of ","|")) %>% 
            separate(JobTitleAdj, into = c("outer","inner"), sep = "\\|")

UofT_ischool$outer2 <- str_wrap(UofT_ischool$outer, width = 15)
`(☞ﾟヮﾟ)☞` <- ggplot(UofT_ischool ,aes(x=outer2, y=SalaryPaid, fill=gender)) + 
    geom_boxplot()
`(☞ﾟヮﾟ)☞`
```

```{r eval=FALSE}
`｡◕‿◕｡` <- ggplot(data = UofT_gen, aes(x=SalaryPaid)) + geom_density(aes(fill=gender), alpha = 0.4)
`｡◕‿◕｡` <- `｡◕‿◕｡` + facet_wrap( ~ gender)
`｡◕‿◕｡` + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


```{r eval=FALSE}
ggplot(UofT_gen, aes(x = SalaryPaid, y = ..density.., fill = gender)) +
  geom_density()

```

```{r eval=FALSE}
UofT_bi <- UofT_gen %>% fastDummies::dummy_cols(select_columns = "gender", ignore_na = TRUE) %>% 
  select(`Last Name`, FirstName, SalaryPaid, `Taxable Benefits`, `Job Title`, CalendarYear, gender_female) %>% 
  mutate(SalaryPaid100 = SalaryPaid/100) %>% select(-SalaryPaid) %>% 
  mutate(CalendarYear = as.integer(as.character(CalendarYear)))

#UofT_bi <- UofT_gen %>% mutate(gender = fastDummies::dummy_cols(select_columns = gender))
  
#UofT_bi_min <- UofT_bi %>% select(CalendarYear,gender_female, SalaryPaid100)



t_prior <- student_t(df = 7, location = 0, scale = 2.5)
fit1 <- stan_glm(gender_female ~ SalaryPaid100, data = UofT_bi,
                 family = binomial(link = "logit"),
                 prior = t_prior, prior_intercept = t_prior,
                 cores = 6, seed = 12345)

summary(fit1)

round(posterior_interval(fit1, prob = 0.5), 2)
```

```{r eval=FALSE}
theme_set(bayesplot::theme_default())
```

```{r eval=FALSE}
# Predicted probability as a function of x
pr_switch <- function(x, ests) plogis(ests[1] + ests[2] * x)
# A function to slightly jitter the binary data
jitt <- function(...) {
  geom_point(aes_string(...), position = position_jitter(height = 0.05, width = 0.1),
             size = 2, shape = 21, stroke = 0.2)
}
ggplot(UofT_bi, aes(x = SalaryPaid100, y = gender_female, color = gender_female)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  jitt(x="SalaryPaid100") +
  stat_function(fun = pr_switch, args = list(ests = coef(fit1)),
                size = 2, color = "gray35")
```


```{r eval=FALSE}
fit2 <- update(fit1, formula = gender_female ~ SalaryPaid100 + CalendarYear)

summary(fit2)

(coef_fit2 <- round(coef(fit2), 3))
```

```{r, fig.width=10,fig.height=11, eval=FALSE}
pr_switch2 <- function(x, y, ests) plogis(ests[1] + ests[2] * x + ests[3] * y)
grid <- expand.grid(SalaryPaid100 = seq(0, 10000, length.out = 101),
                    CalendarYear = seq(2012, 2019)) #seq(2016, 2019))
grid$prob <- with(grid, pr_switch2(SalaryPaid100, CalendarYear, coef(fit2)))
ggplot(grid, aes(x = CalendarYear, y = SalaryPaid100)) +
  geom_tile(aes(fill = prob)) +
  geom_jitter(data = UofT_bi, aes(color = factor(gender_female)), size = 2, alpha = 0.85) +
  scale_fill_gradient() +
  scale_color_manual("female", values = c("white", "black"), labels = c("No", "Yes"))

```


```{r eval=FALSE}
# Quantiles
q_ars <- quantile(UofT_bi$SalaryPaid100, seq(0, 1, 0.25))
q_dist <- quantile(UofT_bi$CalendarYear, seq(0, 1, 0.25))
base <- ggplot(UofT_bi) + xlim(c(0, NA)) +
  scale_y_continuous(breaks = c(0, 0.5, 1))
vary_arsenic <- base + jitt(x="CalendarYear", y="gender_female", color="gender_female") + xlim(2012,2019)#xlim(2016,2019)
vary_dist <- base + jitt(x="SalaryPaid100", y="gender_female", color="gender_female")
for (i in 1:5) {
  vary_dist <-
    vary_dist + stat_function(fun = pr_switch2, color = "gray35",
                              args = list(ests = coef(fit2), y = q_dist[i])
                              )
  vary_arsenic <-
    vary_arsenic + stat_function(fun = pr_switch2, color = "gray35",
                                 args = list(ests = coef(fit2), x = q_ars[i])
                                 )
}
bayesplot_grid(vary_dist, vary_arsenic,
               grid_args = list(ncol = 2))
```

```{r eval=FALSE}
UofT_prof_bi <- UofT_prof %>% rename("JobTitleSimple" = "outer") %>%
    fastDummies::dummy_cols(select_columns = "gender", ignore_na = TRUE) %>%
    select(`Last Name`, FirstName, SalaryPaid, `Taxable Benefits`, JobTitleSimple, CalendarYear, gender_female) %>% 
    mutate(SalaryPaid100 = SalaryPaid/100) %>% select(-SalaryPaid) %>% 
    mutate(CalendarYear = as.integer(as.character(CalendarYear))) 


t_prior <- student_t(df = 7, location = 0, scale = 2.5)
fit3 <- stan_glm(gender_female ~ SalaryPaid100, data = UofT_prof_bi,
                 family = binomial(link = "logit"),
                 prior = t_prior, prior_intercept = t_prior,
                 cores = 6, seed = 12345)

summary(fit3)

round(posterior_interval(fit3, prob = 0.5), 2)
```
```{r eval=FALSE}
# Predicted probability as a function of x
pr_switch <- function(x, ests) plogis(ests[1] + ests[2] * x)
# A function to slightly jitter the binary data
jitt <- function(...) {
  geom_point(aes_string(...), position = position_jitter(height = 0.05, width = 0.1),
             size = 2, shape = 21, stroke = 0.2)
}
ggplot(UofT_prof_bi, aes(x = SalaryPaid100, y = gender_female, color = gender_female)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  jitt(x="SalaryPaid100") +
  stat_function(fun = pr_switch, args = list(ests = coef(fit3)),
                size = 2, color = "gray35")
```
```{r eval=FALSE}
fit4 <- update(fit3, formula = gender_female ~ SalaryPaid100 + JobTitleSimple)

summary(fit4)
(coef_fit4 <- round(coef(fit4), 3))
```

```{r, fig.width=10,fig.height=11, eval=FALSE}

labelsp = c('Assistant Professor','Associate Professor','Associate Professor and Chair',
            'Professor','Professor and Associate Chair','Professor and Chair',
            'Professor and Dean','Professor and Director','Professor and Program Coordinator','University Professor')


pr_switch2 <- function(x, y, ests) plogis(ests[1] + ests[2] * x + ests[3] * y)
grid <- expand.grid(SalaryPaid100 = seq(0, 5000, length.out = 101),
                    JobTitleSimple = seq(0, 10, length.out = 10))
grid$prob <- with(grid, pr_switch2(SalaryPaid100, JobTitleSimple, coef(fit4)))
ggplot(grid, aes(y = SalaryPaid100, x = as.integer(as.factor(JobTitleSimple)))) +
  geom_tile(aes(fill = prob)) +
  scale_fill_gradient() +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10), labels = labelsp) +
  geom_jitter(data = UofT_prof_bi, aes(color = factor(gender_female)), size = 2, alpha = 0.85) +
  scale_color_manual("female", values = c("white", "black"), labels = c("No", "Yes")) 
    

```
```{r eval=FALSE}
UofT_cont <- UofT_gen %>%
    select(`Last Name`, FirstName, SalaryPaid, `Taxable Benefits`, `Job Title`, CalendarYear, gender) %>% 
    mutate(SalaryPaid100 = SalaryPaid/100) %>% select(-SalaryPaid) %>% 
    mutate(CalendarYear = as.integer(as.character(CalendarYear))) 


post1 <- stan_glm(SalaryPaid100 ~ gender, data = UofT_cont,
                  #family = gaussian(link = "identity"),
                  cores = 6, seed = 12345)

summary(post1)


```
```{r eval=FALSE}
base <- ggplot(UofT_cont, aes(x = gender, y = SalaryPaid100)) +
  geom_point(size = 1, position = position_jitter(height = 0.05, width = 0.1)) +ylim(1000,6000)

base + geom_abline(intercept = coef(post1)[1], slope = coef(post1)[2],
                   color = "skyblue4", size = 1)

```
```{r eval=FALSE}
draws <- as.data.frame(post1)
colnames(draws)[1:2] <- c("a", "b")

base +
  geom_abline(data = draws, aes(intercept = a, slope = b),
              color = "skyblue", size = 0.2, alpha = 0.25) +
  geom_abline(intercept = coef(post1)[1], slope = coef(post1)[2],
              color = "skyblue4", size = 1)
```
```{r eval=FALSE}
post2 <- update(post1, formula = . ~ gender + CalendarYear)
summary(post2)
```
```{r eval=FALSE}
reg0 <- function(x, ests) cbind(1, 0, x) %*% ests
reg1 <- function(x, ests) cbind(1, 1, x) %*% ests

args <- list(ests = coef(post2))
lgnd <- guide_legend(title = NULL)
base2 <- ggplot(UofT_cont, aes(x = CalendarYear, fill = gender)) + 
  geom_jitter(aes(y = SalaryPaid100), shape = 21, stroke = .2, size = 1) +
  guides(color = lgnd, fill = lgnd) +
  theme(legend.position = "right") +
  ylim(1000,2000)
base2 +
  stat_function(fun = reg0, args = args, aes(color = "female"), size = 1.5) +
  stat_function(fun = reg1, args = args, aes(color = "male"), size = 1.5) 
```

```{r eval=FALSE}
Salary_SQ <- seq(from = 1000, to = 6000, by = 100)
y_female <- posterior_predict(post2, newdata = data.frame(gender = "female", SalaryPaid100 = Salary_SQ,CalendarYear = 2020))
y_male <- posterior_predict(post2, newdata = data.frame(gender = "male", SalaryPaid100 = Salary_SQ,CalendarYear = 2020))
dim(y_female)
```

```{r eval=FALSE}
par(mfrow = c(1:2), mar = c(5,4,2,1))
boxplot(y_female, axes = FALSE, outline = FALSE, ylim = c(0,3500),
        xlab = "Salary", ylab = "Predicted 2020 Salary", main = "female")
axis(1, at = 1:ncol(y_female), labels = Salary_SQ, las = 3)
axis(2, las = 1)
boxplot(y_male, outline = FALSE, col = "red", axes = FALSE, ylim = c(0,3500),
        xlab = "Salary", ylab = NULL, main = "male")
axis(1, at = 1:ncol(y_female), labels = Salary_SQ, las = 3)
```
```{r eval=FALSE}
UofT_prof_cont <- UofT_prof %>% rename("JobTitleSimple" = "outer") %>%
    select(`Last Name`, FirstName, SalaryPaid, `Taxable Benefits`, JobTitleSimple, CalendarYear, gender) %>% 
    mutate(SalaryPaid100 = SalaryPaid/100) %>% select(-SalaryPaid) %>% 
    mutate(CalendarYear = as.integer(as.character(CalendarYear))) 

post3 <- stan_glm(SalaryPaid100 ~ gender, data = UofT_prof_cont,
                  #family = gaussian(link = "identity"),
                  cores = 6, seed = 12345)

summary(post3)

```
```{r eval=FALSE}
draws <- as.data.frame(post3)
colnames(draws)[1:2] <- c("a", "b")

base +
  geom_abline(data = draws, aes(intercept = a, slope = b),
              color = "skyblue", size = 0.2, alpha = 0.25) +
  geom_abline(intercept = coef(post3)[1], slope = coef(post3)[2],
              color = "skyblue4", size = 1)
```
```{r eval=FALSE}
post4 <- update(post3, formula = . ~ gender + JobTitleSimple)
summary(post4)
```
```{r, fig.width=11, eval=FALSE}
reg0 <- function(x, ests) cbind(1, 0, x) %*% ests
reg1 <- function(x, ests) cbind(1, 1, x) %*% ests

args <- list(ests = coef(post4))
lgnd <- guide_legend(title = NULL)
base2 <- ggplot(UofT_prof_cont, aes(x = JobTitleSimple, fill = gender)) + 
  geom_jitter(aes(y = SalaryPaid100), shape = 21, stroke = .2, size = 1) +
  guides(color = lgnd, fill = lgnd) +
  theme(legend.position = "right") +
  ylim(1000,5000)
base2 +
  stat_function(fun = reg0, args = args, aes(color = "female"), size = 1.5) +
  stat_function(fun = reg1, args = args, aes(color = "male"), size = 1.5) 
```
```{r eval=FALSE}
UofT_prof_sing <- UofT_prof %>% rename("JobTitleSimple" = "outer") %>%
    select(`Last Name`, FirstName, SalaryPaid, `Taxable Benefits`, JobTitleSimple, CalendarYear, gender) %>% 
    mutate(SalaryPaid100 = SalaryPaid/100) %>% select(-SalaryPaid) %>% 
    mutate(CalendarYear = as.integer(as.character(CalendarYear))) %>% 
    filter(JobTitleSimple == "Professor")

post5 <- stan_glm(SalaryPaid100 ~ gender, data = UofT_prof_sing,
                  #family = gaussian(link = "identity"),
                  cores = 6, seed = 12345)

summary(post5)

```

#no work
```{r eval=FALSE}
Salary_SQ <- seq(from = 1000, to = 5900, by = 100)
# y_female <- tibble(gender = "female", SalaryPaid100 = Salary_SQ, JobTitleSimple = "Professor")
# y_female <- posterior_predict(post5, newdata = y_female)
# 
# y_male <- tibble(gender = "male", SalaryPaid100 = Salary_SQ, JobTitleSimple = "Professor")
# y_male <- posterior_predict(post5, newdata = y_male)

y_female <- tibble(gender_female = 0, SalaryPaid100 = Salary_SQ)
y_male <- tibble(gender_female = 1, SalaryPaid100 = Salary_SQ)
rbind(y_female,y_male)

y_<- posterior_predict(fit1, newdata = rbind(y_female,y_male))
```



```{r, fig.width=6, eval=FALSE}
par(mfrow = c(1:2), mar = c(5,4,2,1))
boxplot(y_, axes = FALSE, outline = FALSE, ylim = c(0,1),
        xlab = "Salary", ylab = "Predicted 2020 Salary", main = "female")
axis(1, at = 1:50, labels = Salary_SQ, las = 3)
axis(2, las = 1)
boxplot(y_, outline = FALSE, col = "red", axes = FALSE, ylim = c(0,1),
        xlab = "Salary", ylab = NULL, main = "male")
axis(1, at = 51:100, labels = Salary_SQ, las = 3)
```

\newpage

## References